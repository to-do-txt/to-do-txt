<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropDotTxt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .dropdown-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4), 0 8px 10px -6px rgba(0, 0, 0, 0.4); }
    </style>
</head>
<body class="bg-[#121212] text-gray-200 font-sans h-screen flex flex-col overflow-hidden">

    <div id="status" class="fixed bottom-2 right-4 text-[10px] font-mono z-50 flex items-center gap-2">
        <div id="syncIndicator" class="w-2 h-2 rounded-full bg-green-500"></div>
        <div id="statusText" class="text-gray-500">v2.7.0-stable</div>
    </div>

    <header class="p-4 bg-[#1e1e1e] border-b border-[#333]">
        <div class="max-w-5xl mx-auto flex flex-col gap-4">
            <div class="flex items-center gap-6">
                <div class="font-bold text-xl text-blue-500 cursor-pointer" onclick="resetAll()">DropDotTxt</div>
                <div class="flex-1 relative">
                    <input type="text" id="searchInput" oninput="render()" placeholder="Search tasks..." class="w-full bg-[#0a0a0a] border border-[#333] rounded-full px-10 py-1.5 text-xs outline-none focus:border-blue-500">
                    <span class="absolute left-4 top-2 text-gray-600 text-xs">üîç</span>
                </div>
                <div class="flex items-center gap-4 relative">
                    <button onclick="document.getElementById('sortMenu').classList.toggle('hidden')" class="text-[10px] text-blue-400 hover:text-blue-300 font-bold uppercase tracking-widest flex items-center gap-1">
                        <span>Sort By:</span> <span id="currentSortLabel" class="text-gray-400">Priority</span>
                    </button>
                    
                    <div id="sortMenu" class="hidden absolute top-full right-0 mt-2 w-48 bg-[#1e1e1e] border border-[#333] rounded-lg z-[100] dropdown-shadow p-2">
                        <div class="text-[9px] font-black text-gray-600 uppercase p-2 tracking-tighter">Sort Criteria</div>
                        <button onclick="setSort('priority')" class="w-full text-left px-3 py-2 text-xs hover:bg-blue-600 rounded transition-colors mb-1">Priority</button>
                        <button onclick="setSort('due')" class="w-full text-left px-3 py-2 text-xs hover:bg-blue-600 rounded transition-colors mb-1">Due Date</button>
                        <button onclick="setSort('project')" class="w-full text-left px-3 py-2 text-xs hover:bg-blue-600 rounded transition-colors mb-1">Project</button>
                        <button onclick="setSort('context')" class="w-full text-left px-3 py-2 text-xs hover:bg-blue-600 rounded transition-colors mb-1">Context</button>
                        <div class="border-t border-[#333] my-2"></div>
                        <button onclick="toggleSortDirection()" class="w-full text-left px-3 py-2 text-xs hover:bg-orange-600 rounded transition-colors flex justify-between">
                            <span>Direction</span> <span id="sortDirLabel">DESC</span>
                        </button>
                    </div>

                    <button onclick="toggleCompletedVisibility()" id="toggleVisibleBtn" class="text-[10px] text-purple-400 hover:text-purple-300 font-bold uppercase tracking-widest transition-colors flex items-center gap-1 ml-2">
                        <span id="eyeIcon">üëÅÔ∏è</span> <span id="visibleText">Hide Done</span>
                    </button>
                    <button onclick="toggleRawEdit()" class="text-[10px] text-orange-400 hover:text-orange-300 font-bold uppercase tracking-widest ml-2">Raw Edit</button>
                </div>
            </div>

            <div id="addBar" class="flex flex-wrap gap-2 items-center">
                <input type="text" id="newTodo" onkeypress="if(event.key === 'Enter') addTask()" placeholder="Add task (A) @Adam +Project due:2026-02-28..." class="flex-1 min-w-[200px] bg-[#0a0a0a] border border-[#444] rounded px-4 py-2 outline-none focus:border-blue-500 text-sm">
                <button onclick="addTask()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold text-sm transition-all">Add</button>
                <div id="activeFilters" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <aside class="w-64 p-6 hidden md:block overflow-y-auto border-r border-[#333]">
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Priority</h2>
            <div id="priorityList" class="space-y-1 mb-8 text-sm"></div>
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Due</h2>
            <div id="dueList" class="space-y-1 mb-8 text-sm"></div>
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Projects</h2>
            <div id="projectList" class="space-y-1 mb-8 text-sm"></div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto relative">
            <div id="todoList" class="space-y-1 max-w-4xl mx-auto w-full pb-20"></div>
            <div id="rawEditorContainer" class="hidden flex-1 flex flex-col max-w-4xl mx-auto w-full h-full pb-10">
                <textarea id="rawEditor" class="flex-1 bg-[#0a0a0a] text-gray-300 font-mono text-sm p-4 border border-[#333] rounded outline-none h-full resize-none"></textarea>
                <button onclick="saveRawEdit()" class="mt-4 bg-orange-600 hover:bg-orange-500 text-white py-2 rounded text-[10px] font-bold uppercase tracking-widest">Save File</button>
            </div>
        </main>
    </div>

    <script>
        // CLIENT_ID and DBX Init logic same as previous version...
        let allTasks = [], activeFilters = new Set(), isRawEditing = false, showCompleted = true;
        let currentSort = 'priority', sortAsc = false;

        function setSort(type) {
            currentSort = type;
            document.getElementById('currentSortLabel').innerText = type.charAt(0).toUpperCase() + type.slice(1);
            document.getElementById('sortMenu').classList.add('hidden');
            render();
        }

        function toggleSortDirection() {
            sortAsc = !sortAsc;
            document.getElementById('sortDirLabel').innerText = sortAsc ? 'ASC' : 'DESC';
            render();
        }

        function getTaskMeta(text) {
            const prio = text.match(/^\(([A-Z])\)/);
            const due = text.match(/due:(\d{4}-\d{2}-\d{2})/);
            const proj = text.match(/\+(\w+)/);
            const ctx = text.match(/@(\w+)/);
            return {
                priority: prio ? prio[1] : 'Z',
                due: due ? due[1] : '9999-12-31',
                project: proj ? proj[1] : 'ZZZ',
                context: ctx ? ctx[1] : 'ZZZ',
                isHeader: text.startsWith('#')
            };
        }

        function render() {
            const list = document.getElementById('todoList'), search = document.getElementById('searchInput').value.toLowerCase();
            let display = allTasks.map((text, originalIndex) => ({ text, originalIndex, meta: getTaskMeta(text) }));

            // Filters
            if (!showCompleted) display = display.filter(t => !t.text.startsWith('x ') || t.meta.isHeader);
            activeFilters.forEach(f => { display = display.filter(t => t.text.includes(f) || t.meta.isHeader); });
            if (search) display = display.filter(t => t.text.toLowerCase().includes(search) || t.meta.isHeader);

            // Virtual Sorting Logic
            display.sort((a, b) => {
                if (a.meta.isHeader || b.meta.isHeader) {
                    if (a.meta.isHeader && b.meta.isHeader) return a.originalIndex - b.originalIndex;
                    return a.meta.isHeader ? -1 : 1;
                }

                let valA = a.meta[currentSort], valB = b.meta[currentSort];
                let comparison = valA.localeCompare(valB);
                
                if (comparison === 0) return a.originalIndex - b.originalIndex; // Secondary sort: original order
                return sortAsc ? comparison : -comparison;
            });

            list.innerHTML = display.map(item => {
                const hMatch = item.text.match(/^(#+)\s+(.*)$/);
                if (hMatch) return `<div class="pt-8 pb-2 border-b border-[#333] mb-4 text-blue-500 font-black uppercase text-xs tracking-widest">${hMatch[2]}</div>`;

                const isDone = item.text.startsWith('x ');
                const border = isDone ? 'border-l-gray-700 opacity-40' : item.meta.priority === 'A' ? 'border-l-red-500' : 'border-l-blue-600';
                
                return `<div class="group flex items-center bg-[#1e1e1e] border-l-4 ${border} mb-1 p-3 hover:bg-[#252525]">
                    <input type="checkbox" ${isDone ? 'checked' : ''} onclick="toggleTask(${item.originalIndex})" class="w-4 h-4 mr-4">
                    <span class="flex-1 text-sm ${isDone ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    <button onclick="deleteTask(${item.originalIndex})" class="opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 px-2 transition-all text-xs">‚úï</button>
                </div>`;
            }).join('');
            
            updateSidebars();
        }

        // Logic for updateSidebars, toggleTask, saveTasks etc. stays the same...
        // ... (standard todo.txt logic) ...

        init();
    </script>
</body>
</html>
