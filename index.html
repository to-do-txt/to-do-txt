<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropDotTxt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body class="bg-[#121212] text-gray-200 font-sans h-screen flex flex-col overflow-hidden">

    <div class="fixed bottom-2 right-4 text-[10px] font-mono z-50 flex items-center gap-2">
        <div id="syncIndicator" class="w-2 h-2 rounded-full bg-green-500"></div>
        <div id="statusText" class="text-gray-500">v1.4.1-stable</div>
    </div>

    <div id="loginOverlay" class="fixed inset-0 bg-[#121212] z-50 flex items-center justify-center hidden">
        <div class="text-center bg-[#1e1e1e] p-10 rounded-2xl border border-gray-800 shadow-2xl">
            <h1 class="text-3xl font-bold mb-2 text-blue-500">DropDotTxt</h1>
            <button onclick="doLogin()" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-3 rounded-lg font-bold transition-all mt-4">Connect Dropbox</button>
        </div>
    </div>

    <header class="p-4 bg-[#1e1e1e] border-b border-[#333]">
        <div class="max-w-5xl mx-auto flex items-center gap-6">
            <div class="font-bold text-xl text-blue-500 tracking-tight">DropDotTxt</div>
            <div class="flex-1 flex gap-2">
                <input type="text" id="newTodo" onkeypress="if(event.key === 'Enter') addTask()" placeholder="Add task... (A) Task +Project @Context due:2026-02-28" class="flex-1 bg-[#0a0a0a] border border-[#444] rounded px-4 py-2 outline-none focus:border-blue-500 text-sm">
                <button id="addBtn" onclick="addTask()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded font-bold text-sm transition-colors">Add</button>
            </div>
            <button onclick="doLogout()" class="text-xs text-gray-500 hover:text-red-400">Logout</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <aside class="w-64 p-6 hidden md:block overflow-y-auto border-r border-[#333] bg-[#121212]">
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Schedule</h2>
            <div id="dueList" class="space-y-1 mb-8 text-sm font-medium text-yellow-500"></div>
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Projects</h2>
            <div id="projectList" class="space-y-1 mb-8 text-sm font-medium text-blue-400"></div>
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Contexts</h2>
            <div id="contextList" class="space-y-1 text-sm font-medium text-green-400"></div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto bg-[#121212]">
            <div id="todoList" class="space-y-1 max-w-4xl mx-auto pb-20"></div>
        </main>
    </div>

    <script>
        const CLIENT_ID = 'aqxrpwdf3f2l9hx'; 
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
        let dbx;
        let allTasks = [];

        function setStatus(msg, type = 'idle') {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('statusText');
            if (text) text.innerText = msg;
            if (indicator) indicator.className = `w-2 h-2 rounded-full ${type === 'error' ? 'bg-red-500' : type === 'syncing' ? 'bg-yellow-500 animate-pulse' : 'bg-green-500'}`;
        }

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const token = localStorage.getItem('dbx_token');

            if (token) {
                if (code) window.history.replaceState({}, document.title, REDIRECT_URI);
                startApp(token);
            } else if (code) {
                try {
                    const verifier = localStorage.getItem('dbx_verifier');
                    dbxAuth.setCodeVerifier(verifier);
                    const resp = await dbxAuth.getAccessTokenFromCode(REDIRECT_URI, code);
                    localStorage.setItem('dbx_token', resp.result.access_token);
                    localStorage.removeItem('dbx_verifier');
                    window.location.href = REDIRECT_URI;
                } catch (e) { doLogout(); }
            } else {
                document.getElementById('loginOverlay').classList.remove('hidden');
            }
        }

        async function doLogin() {
            localStorage.removeItem('dbx_token');
            const authUrl = await dbxAuth.getAuthenticationUrl(REDIRECT_URI, null, 'code', 'offline', null, 'none', true);
            localStorage.setItem('dbx_verifier', dbxAuth.getCodeVerifier());
            window.location.href = authUrl;
        }

        function doLogout() {
            localStorage.clear();
            window.location.href = REDIRECT_URI;
        }

        function startApp(token) {
            dbx = new Dropbox.Dropbox({ accessToken: token });
            loadTasks();
        }

        async function loadTasks() {
            setStatus('Loading...', 'syncing');
            try {
                const response = await dbx.filesDownload({ path: '/todo.txt' });
                const text = await response.result.fileBlob.text();
                allTasks = text.split('\n').filter(t => t.trim() !== "");
                setStatus('v1.4.1-stable');
                render();
            } catch (e) {
                allTasks = ["(A) App Connected! Add a task to begin."];
                render();
            }
        }

        async function saveTasks() {
            setStatus('Syncing...', 'syncing');
            try {
                const content = allTasks.join('\n');
                await dbx.filesUpload({ 
                    path: '/todo.txt', 
                    contents: content, 
                    mode: { ".tag": "overwrite" }
                });
                setStatus('Synced');
                setTimeout(() => setStatus('v1.4.1-stable'), 2000);
            } catch (error) { setStatus('Sync Error', 'error'); }
        }

        function addTask() {
            const input = document.getElementById('newTodo');
            if (!input.value.trim()) return;
            if (allTasks.length === 1 && allTasks[0].includes("App Connected!")) allTasks = [];
            allTasks.push(input.value.trim());
            input.value = "";
            render();
            saveTasks();
        }

        function toggleTask(idx) {
            let task = allTasks[idx];
            const today = new Date().toISOString().split('T')[0];
            if (task.startsWith('x ')) {
                allTasks[idx] = task.replace(/^x \d{4}-\d{2}-\d{2} /, '');
            } else {
                allTasks[idx] = `x ${today} ${task}`;
            }
            render();
            saveTasks();
        }

        function updateTaskText(idx, newText) {
            if (allTasks[idx] === newText.trim()) return;
            allTasks[idx] = newText.trim();
            saveTasks();
            render(); 
        }

        function deleteTask(idx) {
            allTasks.splice(idx, 1);
            render();
            saveTasks();
        }

        function render() {
            const list = document.getElementById('todoList');
            if (!list) return;

            // Simplified render: No sorting within the UI to prevent index-mismatching crashes
            list.innerHTML = allTasks.map((t, i) => {
                const isDone = t.startsWith('x ');
                let color = "border-l-blue-600";
                let textColor = "text-gray-200";
                
                if(isDone) {
                    color = "border-l-gray-700 opacity-50";
                    textColor = "text-gray-500 line-through";
                } else if(t.startsWith("(A)")) {
                    color = "border-l-red-500";
                    textColor = "text-red-400 font-bold";
                }

                return `
                <div class="group flex items-center bg-[#1e1e1e] border-l-4 ${color} mb-1 p-3 hover:bg-[#252525] transition-all">
                    <input type="checkbox" ${isDone ? 'checked' : ''} onclick="toggleTask(${i})" class="w-4 h-4 mr-4 cursor-pointer accent-blue-500">
                    <input type="text" 
                           value="${t.replace(/"/g, '&quot;')}" 
                           onblur="updateTaskText(${i}, this.value)"
                           onkeypress="if(event.key === 'Enter') { this.blur(); }"
                           class="flex-1 bg-transparent outline-none border-none ${textColor} text-sm focus:bg-[#121212] px-1 rounded">
                    <button onclick="deleteTask(${i})" class="text-gray-600 hover:text-red-500 px-2 font-bold opacity-0 group-hover:opacity-100 transition-opacity">âœ•</button>
                </div>`;
            }).join('');
            
            // Sidebar Update
            const fullText = allTasks.join(' ');
            const dueDates = [...new Set(fullText.match(/due:\d{4}-\d{2}-\d{2}/g))].sort();
            document.getElementById('dueList').innerHTML = (dueDates || []).map(d => `<div>${d.replace('due:', '')}</div>`).join('');
            const projects = [...new Set(fullText.match(/\+\w+/g))].sort();
            document.getElementById('projectList').innerHTML = (projects || []).map(p => `<div>${p}</div>`).join('');
            const contexts = [...new Set(fullText.match(/@\w+/g))].sort();
            document.getElementById('contextList').innerHTML = (contexts || []).map(c => `<div>${c}</div>`).join('');
        }

        init();
    </script>
</body>
</html>
