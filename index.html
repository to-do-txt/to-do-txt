<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropDotTxt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body class="bg-[#1e1e1e] text-gray-200 font-sans h-screen flex flex-col overflow-hidden">

    <div id="loginOverlay" class="fixed inset-0 bg-[#1e1e1e] z-50 flex items-center justify-center hidden">
        <div class="text-center bg-[#252525] p-10 rounded-2xl border border-gray-800 shadow-2xl">
            <h1 class="text-3xl font-bold mb-2 text-blue-400">DropDotTxt</h1>
            <p class="text-gray-400 mb-8">Connect to sync your todo.txt</p>
            <button onclick="doLogin()" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-3 rounded-lg font-bold transition-all transform hover:scale-105">
                Connect Dropbox
            </button>
        </div>
    </div>

    <header class="p-4 bg-[#252525] border-b border-[#333] shadow-lg">
        <div class="max-w-5xl mx-auto flex items-center gap-6">
            <div class="font-bold text-xl text-blue-400 tracking-tight">DropDotTxt</div>
            <div class="flex-1 flex gap-2">
                <input type="text" id="newTodo" 
                       onkeypress="if(event.key === 'Enter') addTask()"
                       placeholder="Add task... (A) Task +Project @Context" 
                       class="flex-1 bg-[#121212] border border-[#444] rounded px-4 py-2 outline-none focus:border-blue-500 text-sm">
                <button onclick="addTask()" class="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded font-bold text-sm transition-colors">Add</button>
            </div>
            <button onclick="doLogout()" class="text-xs text-gray-500 hover:text-red-400 transition-colors">Logout</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden max-w-7xl mx-auto w-full">
        <aside class="w-64 p-6 hidden md:block overflow-y-auto border-r border-[#333] bg-[#1a1a1a]">
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Projects</h2>
            <div id="projectList" class="space-y-1 mb-8 text-sm font-medium"></div>
            <h2 class="text-[10px] font-black text-gray-500 mb-4 uppercase tracking-widest">Contexts</h2>
            <div id="contextList" class="space-y-1 text-sm font-medium"></div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto bg-[#1e1e1e]">
            <div id="todoList" class="space-y-1 max-w-4xl mx-auto">
                <div id="statusMessage" class="text-center text-gray-600 mt-10">Initializing...</div>
            </div>
        </main>
    </div>

    <script>
        const CLIENT_ID = 'aqxrpwdf3f2l9hx'; 
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const dbxAuth = new Dropbox.DropboxAuth({ clientId: CLIENT_ID });
        let dbx;
        let allTasks = [];

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const cachedToken = sessionStorage.getItem('dbx_token');
            
            // 1. If we have a token, use it and ignore the URL code
            if (cachedToken) {
                if (code) cleanUrl();
                startApp(cachedToken);
                return;
            }

            // 2. If we have a code but no token, exchange it
            if (code) {
                try {
                    const resp = await dbxAuth.getAccessTokenFromCode(REDIRECT_URI, code);
                    const token = resp.result.access_token;
                    sessionStorage.setItem('dbx_token', token);
                    cleanUrl();
                    startApp(token);
                } catch (e) {
                    console.error("Auth Loop Error:", e);
                    doLogout(); // Reset if the code is invalid/expired
                }
            } else {
                showLogin();
            }
        }

        function cleanUrl() {
            window.history.replaceState({}, document.title, REDIRECT_URI);
        }

        function showLogin() { 
            document.getElementById('loginOverlay').classList.remove('hidden'); 
        }
        
        async function doLogin() { 
            sessionStorage.removeItem('dbx_token');
            const authUrl = await dbxAuth.getAuthenticationUrl(REDIRECT_URI, null, 'code', 'offline', null, 'none', true);
            window.location.href = authUrl; 
        }

        function doLogout() { 
            sessionStorage.removeItem('dbx_token'); 
            window.location.href = REDIRECT_URI;
        }
        
        function startApp(token) { 
            dbx = new Dropbox.Dropbox({ accessToken: token }); 
            loadTasks(); 
        }

        async function loadTasks() {
            try {
                const response = await dbx.filesDownload({ path: '/todo.txt' });
                const text = await response.result.fileBlob.text();
                allTasks = text.split('\n').filter(t => t.trim() !== "");
                render();
            } catch (e) {
                allTasks = ["(A) Task synced! Add your first one above."];
                render();
            }
        }

        async function saveTasks() {
            try {
                const content = allTasks.join('\n');
                await dbx.filesUpload({ 
                    path: '/todo.txt', 
                    contents: content, 
                    mode: { ".tag": "overwrite" } 
                });
                console.log("Dropbox Sync Successful");
            } catch (error) {
                console.error("Dropbox Save Error:", error);
                if (error.status === 403) {
                    alert("Write Permission Denied. Logging out to refresh permissions.");
                    doLogout();
                }
            }
        }

        async function addTask() {
            const input = document.getElementById('newTodo');
            const val = input.value.trim();
            if (!val) return;
            
            allTasks.push(val);
            input.value = "";
            render(); 
            await saveTasks();
        }

        async function deleteTask(index) {
            allTasks.splice(index, 1);
            render();
            await saveTasks();
        }

        function render() {
            const list = document.getElementById('todoList');
            allTasks.sort();
            
            if (allTasks.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-600 mt-10">No tasks found.</div>`;
            } else {
                list.innerHTML = allTasks.map((t, i) => {
                    let color = "border-l-blue-500";
                    if(t.startsWith("(A)")) color = "border-l-red-500 text-red-400";
                    else if(t.startsWith("(B)")) color = "border-l-orange-400 text-orange-300";
                    
                    return `
                    <div class="group flex items-center bg-[#252525] border-l-4 ${color} mb-1 p-3 shadow-sm hover:bg-[#2d2d2d] transition-all">
                        <span class="flex-1 text-sm tracking-wide">${t}</span>
                        <button onclick="deleteTask(${i})" class="text-gray-600 group-hover:text-red-500 px-3 py-1 transition-colors font-bold">âœ•</button>
                    </div>`;
                }).join('');
            }
            
            const text = allTasks.join(' ');
            const projects = [...new Set(text.match(/\+\w+/g))];
            const contexts = [...new Set(text.match(/@\w+/g))];
            
            document.getElementById('projectList').innerHTML = (projects || []).map(p => `<div class="text-blue-400 py-1">${p}</div>`).join('');
            document.getElementById('contextList').innerHTML = (contexts || []).map(c => `<div class="text-green-400 py-1">${c}</div>`).join('');
        }

        init();
    </script>
</body>
</html>
