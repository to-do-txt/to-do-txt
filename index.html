<main class="flex-1 p-4 md:p-6 overflow-y-auto w-full">
        <div id="focusBanner" class="hidden max-w-4xl mx-auto mb-6 bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 flex justify-between items-center">
            <div>
                <div class="text-[10px] font-black uppercase tracking-widest text-blue-400 mb-1">Project Focus</div>
                <h2 id="focusTitle" class="text-xl font-bold text-white tracking-tight"></h2>
                <div class="w-48 h-1.5 bg-gray-800 rounded-full mt-2 overflow-hidden">
                    <div id="focusProgress" class="h-full bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <button onclick="resetAll()" class="text-gray-400 hover:text-white text-xl px-4">✕</button>
        </div>

        <div id="todoList" class="space-y-1 max-w-4xl mx-auto w-full pb-20"></div>
        </main>

    <script>
        // ... (Keep existing init and Dropbox logic) ...
        let activeProject = null; // New state tracker

        function render() {
            const list = document.getElementById('todoList'), search = document.getElementById('searchInput').value.toLowerCase();
            const banner = document.getElementById('focusBanner');
            const focusTitle = document.getElementById('focusTitle');
            const focusProgress = document.getElementById('focusProgress');

            let display = allTasks.map((text, originalIndex) => ({ text, originalIndex, meta: getTaskMeta(text) }));
            
            // Handle Project Focus UI
            if (activeProject) {
                banner.classList.remove('hidden');
                focusTitle.innerText = activeProject.replace('+', '');
                
                const projectTasks = allTasks.filter(t => t.includes(activeProject) && !t.startsWith('#'));
                const completed = projectTasks.filter(t => t.startsWith('x ')).length;
                const total = projectTasks.length;
                const percent = total > 0 ? (completed / total) * 100 : 0;
                focusProgress.style.width = `${percent}%`;
            } else {
                banner.classList.add('hidden');
            }

            // Filtering Logic
            if (!showCompleted || showPastDueOnly) display = display.filter(t => !t.text.startsWith('x ') || t.meta.isHeader);
            if (showPastDueOnly) display = display.filter(t => t.meta.isPastDue || t.meta.isHeader);
            if (activeProject) display = display.filter(t => t.text.includes(activeProject) || t.meta.isHeader);
            
            activeFilters.forEach(f => { display = display.filter(t => t.text.includes(f) || t.meta.isHeader); });
            if (search) display = display.filter(t => t.text.toLowerCase().includes(search) || t.meta.isHeader);

            list.innerHTML = display.map(item => {
                if (item.meta.isHeader) return `<div class="pt-8 pb-2 border-b border-[#333] mb-4 text-blue-500 font-black uppercase text-[10px] tracking-widest">${item.text.replace(/#+\s+/, '')}</div>`;
                const isDone = item.text.startsWith('x ');
                const isEditing = editingIndex === item.originalIndex;
                let content;
                
                // Content rendering logic (Keep same as v3.2.3)
                if (isEditing) {
                    content = `<input id="edit-${item.originalIndex}" type="text" value="${item.text.replace(/"/g, '&quot;')}" class="flex-1 bg-[#0a0a0a] border border-blue-500 rounded px-2 py-0.5 text-sm outline-none text-white" onblur="finishEditing(${item.originalIndex}, this.value)" onkeypress="if(event.key==='Enter') finishEditing(${item.originalIndex}, this.value)">`;
                } else {
                    let hText = item.text
                        .replace(/(\([A-Z]\))/g, '<span class="text-orange-400 font-bold">$1</span>')
                        .replace(/(\+\w+)/g, '<span class="text-blue-400 font-bold">$1</span>')
                        .replace(/(@\w+)/g, '<span class="text-green-400 font-bold">$1</span>')
                        .replace(/(due:\d{4}-\d{2}-\d{2})/g, '<span class="text-yellow-500">$1</span>')
                        .replace(/(\d{4}-\d{2}-\d{2})/g, '<span class="text-gray-500 font-mono text-[11px] mr-1">$1</span>')
                        .replace(/link:((https?:\/\/|www\.)[^\s]+)/g, (match, url) => {
                            const href = url.startsWith('www.') ? `http://${url}` : url;
                            return `<a href="${href}" target="_blank" class="text-blue-500 underline hover:text-blue-400 inline-flex items-center gap-1 font-bold" onclick="event.stopPropagation()">link <span class="text-[10px]">↗️</span></a>`;
                        });
                    content = `<div class="flex-1 text-sm cursor-text ${isDone ? 'line-through text-gray-500 font-mono italic text-xs' : ''}" onclick="startEditing(${item.originalIndex})">${hText}</div>`;
                }

                const p = item.meta.priority;
                const pClass = isDone ? 'border-l-gray-700 opacity-40' : (p === 'A' ? 'prio-a' : p === 'B' ? 'prio-b' : p === 'C' ? 'prio-c' : 'prio-none');
                return `<div class="group flex items-center bg-[#1e1e1e] border-l-4 ${pClass} mb-1 p-3 hover:bg-[#252525] rounded-r shadow-sm">
                    <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleTask(${item.originalIndex})" class="w-5 h-5 mr-4 cursor-pointer accent-blue-500">
                    ${content}
                    <button onclick="deleteTask(${item.originalIndex})" class="md:opacity-0 group-hover:opacity-100 text-gray-600 hover:text-red-500 px-2">✕</button>
                </div>`;
            }).join('');
            updateSidebars();
        }

        function toggleProjectFocus(p) {
            if (activeProject === p) activeProject = null;
            else {
                activeProject = p;
                activeFilters.clear();
                showPastDueOnly = false;
            }
            render();
        }

        function updateSidebars() {
            // Sidebar logic: If a project is focused, counts should reflect ONLY that project's tasks
            const openTasks = allTasks.filter(t => !t.startsWith('x ') && !t.startsWith('#'));
            const baseTasks = activeProject 
                ? openTasks.filter(t => t.includes(activeProject)) 
                : (showPastDueOnly ? allTasks.filter(t => getTaskMeta(t).isPastDue) : openTasks);

            const totalOpen = openTasks.length;
            const pastDueCount = allTasks.filter(t => getTaskMeta(t).isPastDue).length;
            
            document.getElementById('dashboardMetrics').innerHTML = `
                <div class="flex justify-between items-center mb-2 text-blue-400">
                    <span>Total Open</span>
                    <span class="text-[10px] bg-blue-900/30 px-2 py-0.5 rounded text-blue-400 font-bold">${totalOpen}</span>
                </div>
                <div onclick="togglePastDue()" class="flex justify-between items-center cursor-pointer mb-2 ${showPastDueOnly ? 'text-white font-bold' : 'text-red-400 hover:text-white'}">
                    <span>Past Due</span>
                    <span class="text-[10px] bg-red-900/30 px-2 py-0.5 rounded text-red-400 font-bold">${pastDueCount}</span>
                </div>`;

            const sb = (id, re, c, isProject = false) => {
                const items = [...new Set(allTasks.join(' ').match(re) || [])].sort();
                document.getElementById(id).innerHTML = items.map(v => {
                    const count = baseTasks.filter(t => t.includes(v)).length;
                    if (count === 0 && !activeFilters.has(v) && activeProject !== v) return "";
                    
                    const onClick = isProject ? `toggleProjectFocus('${v}')` : `toggleFilter('${v}')`;
                    const isActive = isProject ? activeProject === v : activeFilters.has(v);
                    
                    return `<div onclick="${onClick}" class="flex justify-between items-center cursor-pointer mb-2 ${isActive ? 'text-white font-bold underline decoration-blue-500 decoration-2 underline-offset-4' : c + ' hover:text-white'}">
                        <span>${v.replace('due:','')}</span><span class="text-[10px] bg-[#222] px-2 py-0.5 rounded text-gray-400">${count}</span>
                    </div>`;
                }).join('');
            };
            sb('priorityList', /\([A-Z]\)/g, 'text-orange-400');
            sb('dueList', /due:\d{4}-\d{2}-\d{2}/g, 'text-yellow-500');
            sb('projectList', /\+\w+/g, 'text-blue-400', true);
            sb('contextList', /@\w+/g, 'text-green-400');
        }

        function resetAll() { 
            activeFilters.clear(); 
            activeProject = null;
            showPastDueOnly = false;
            showCompleted = true;
            document.getElementById('doneToggle').innerText = "Hide Done";
            document.getElementById('searchInput').value = ""; 
            render(); 
        }

        // ... (Keep togglePastDue, toggleFilter, etc.) ...
    </script>
